{% extends "portfolio/admin_base.html" %}

{% block title %}Updates{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Updates</h1>
        <p class="sub">Version history — run <code style="color:#00d9ff; background:#1a2736; padding:0.15rem 0.4rem; border-radius:4px; font-size:0.75rem;">python manage.py log_update</code> after each deploy</p>
    </div>
</div>

{% if updates %}

<!-- LATEST VERSION HIGHLIGHT -->
<div style="background:#1a2736; border:1px solid #00d9ff; border-radius:10px; padding:1.2rem 1.4rem; margin-bottom:1.8rem; display:flex; align-items:center; gap:1.4rem;">
    <div style="background:#00d9ff; color:#0f1923; font-weight:700; font-size:0.78rem; padding:0.35rem 0.75rem; border-radius:20px; white-space:nowrap; letter-spacing:0.5px;">
        LATEST
    </div>
    <div style="flex:1;">
        <div style="display:flex; align-items:baseline; gap:0.8rem; flex-wrap:wrap;">
            <span style="color:#fff; font-weight:600; font-size:1rem;">{{ updates.0.version }}</span>
            <span style="color:#5a7a9a; font-size:0.76rem;">{{ updates.0.deployed_at|date:"d M Y H:i" }}</span>
        </div>
        <p style="color:#c8d6e5; margin-top:0.25rem; font-size:0.85rem;">{{ updates.0.summary }}</p>
    </div>
</div>

<!-- FULL TIMELINE TABLE -->
<div class="table-wrap">
    <table>
        <thead>
            <tr>
                <th style="width:30px"></th>
                <th>Version</th>
                <th>Summary</th>
                <th>Author</th>
                <th>Machine IP</th>
                <th>When</th>
            </tr>
        </thead>
        <tbody>
            {% for u in updates %}
            <!-- main row -->
            <tr id="urow-{{ forloop.counter }}" onclick="toggleUpdate({{ forloop.counter }})" style="cursor:pointer;">
                <td style="color:#5a7a9a; user-select:none;" id="uarrow-{{ forloop.counter }}">▸</td>
                <td>
                    <span class="badge badge-cyan">{{ u.version }}</span>
                </td>
                <td style="color:#fff;">{{ u.summary }}</td>
                <td style="color:#5a7a9a;">{{ u.author|default:"—" }}</td>
                <td style="color:#5a7a9a;">{{ u.machine_ip|default:"—" }}</td>
                <td style="color:#5a7a9a; white-space:nowrap;">{{ u.deployed_at|date:"d M Y H:i" }}</td>
            </tr>
            <!-- expandable: changed files -->
            <tr id="uexpand-{{ forloop.counter }}" style="display:none;">
                <td colspan="6" style="padding:0;">
                    <div style="padding:0.75rem 1rem 0.9rem; background:#162230; border-top:1px solid #2c3e50;">
                        <div style="font-size:0.7rem; text-transform:uppercase; letter-spacing:1px; color:#5a7a9a; margin-bottom:0.4rem;">Changed Files</div>
                        {% if u.changed_files %}
                            {% for f in u.changed_files.split %}
                            <span class="badge badge-orange" style="margin-right:0.3rem; margin-bottom:0.3rem; display:inline-block;">{{ f }}</span>
                            {% endfor %}
                        {% else %}
                            <span style="color:#3a5068; font-size:0.8rem;">No file list recorded.</span>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% else %}
<!-- EMPTY STATE -->
<div class="table-wrap">
    <div class="empty">
        <p style="margin-bottom:0.6rem; color:#5a7a9a;">No updates logged yet.</p>
        <p style="font-size:0.78rem; color:#3a5068;">
            Make a git commit, then run:<br>
            <code style="color:#00d9ff; background:#1a2736; padding:0.2rem 0.5rem; border-radius:4px; margin-top:0.3rem; display:inline-block;">
                python manage.py log_update
            </code>
        </p>
    </div>
</div>
{% endif %}

<script>
function toggleUpdate(n) {
    var expand = document.getElementById('uexpand-' + n);
    var arrow  = document.getElementById('uarrow-' + n);
    var row    = document.getElementById('urow-' + n);
    var open   = expand.style.display === 'block';
    expand.style.display = open ? 'none' : 'block';
    arrow.textContent    = open ? '▸' : '▾';
    row.style.background = open ? '' : 'rgba(0,217,255,0.04)';
}
</script>
{% endblock %}